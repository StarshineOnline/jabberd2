#! /bin/sh /usr/share/dpatch/dpatch-run
# Origin: Tomasz Sterna
# Description: fix for "billion laughs" attack (CVE-2011-1755)

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' jabberd2-2.0s11~/sx/callback.c jabberd2-2.0s11/sx/callback.c
--- jabberd2-2.0s11~/sx/callback.c	2004-11-08 15:35:59.000000000 -0600
+++ jabberd2-2.0s11/sx/callback.c	2011-05-03 20:04:43.000000000 -0500
@@ -154,3 +154,17 @@
     s->nad->scope = ns;
 }
 
+#ifdef HAVE_XML_STOPPARSER
+/* Stop the parser if an entity declaration is hit. */
+void _sx_entity_declaration(void *arg, const char *entityName,
+                            int is_parameter_entity, const char *value,
+                            int value_length, const char *base,
+                            const char *systemId, const char *publicId,
+                            const char *notationName)
+{
+    sx_t s = (sx_t) arg;
+
+    XML_StopParser(s->expat, XML_FALSE);
+}
+#endif
+
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' jabberd2-2.0s11~/sx/sx.c jabberd2-2.0s11/sx/sx.c
--- jabberd2-2.0s11~/sx/sx.c	2004-05-31 18:01:56.000000000 -0500
+++ jabberd2-2.0s11/sx/sx.c	2011-05-03 20:04:43.000000000 -0500
@@ -37,6 +37,16 @@
     s->expat = XML_ParserCreateNS(NULL, '|');
     XML_SetReturnNSTriplet(s->expat, 1);
     XML_SetUserData(s->expat, (void *) s);
+    /* Prevent the "billion laughs" attack against expat by disabling
+     * internal entity expansion.  With 2.x, forcibly stop the parser
+     * if an entity is declared - this is safer and a more obvious
+     * failure mode.  With older versions, simply prevent expenansion
+     * of such entities. */
+#ifdef HAVE_XML_STOPPARSER
+    XML_SetEntityDeclHandler(s->expat, (void *) _sx_entity_declaration);
+#else
+    XML_SetDefaultHandler(s->expat, NULL);
+#endif
 
     s->nad_cache = nad_cache_new();
 
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' jabberd2-2.0s11~/sx/sx.h jabberd2-2.0s11/sx/sx.h
--- jabberd2-2.0s11~/sx/sx.h	2004-04-29 21:43:01.000000000 -0500
+++ jabberd2-2.0s11/sx/sx.h	2011-05-03 20:08:03.000000000 -0500
@@ -178,6 +178,13 @@
 void                        _sx_element_end(void *arg, const char *name);
 void                        _sx_cdata(void *arg, const char *str, int len);
 void                        _sx_namespace_start(void *arg, const char *prefix, const char *uri);
+#ifdef HAVE_XML_STOPPARSER
+void                        _sx_entity_declaration(void *arg, const char *entityName,
+                                                   int is_parameter_entity, const char *value,
+                                                   int value_length, const char *base,
+                                                   const char *systemId, const char *publicId,
+                                                   const char *notationName);
+#endif
 
 /** processor for incoming wire data */
 void                        _sx_process_read(sx_t s, sx_buf_t buf);
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' jabberd2-2.0s11~/util/nad.c jabberd2-2.0s11/util/nad.c
--- jabberd2-2.0s11~/util/nad.c	2005-04-07 03:10:34.000000000 -0500
+++ jabberd2-2.0s11/util/nad.c	2011-05-03 20:10:15.000000000 -0500
@@ -1005,6 +1005,7 @@
 struct build_data {
     nad_t               nad;
     int                 depth;
+    XML_Parser          p;
 };
 
 static void _nad_parse_element_start(void *arg, const char *name, const char **atts) {
@@ -1107,6 +1108,20 @@
     bd->nad->scope = ns; 
 }
 
+#ifdef HAVE_XML_STOPPARSER
+/* Stop the parser if an entity declaration is hit. */
+static void _nad_parse_entity_declaration(void *arg, const char *entityName,
+                                          int is_parameter_entity, const char *value,
+                                          int value_length, const char *base,
+                                          const char *systemId, const char *publicId,
+                                          const char *notationName)
+{
+    struct build_data *bd = (struct build_data *) arg;
+
+    XML_StopParser(bd->p, XML_FALSE);
+}
+#endif
+
 nad_t nad_parse(nad_cache_t cache, const char *buf, int len) {
     struct build_data bd;
     XML_Parser p;
@@ -1117,8 +1132,19 @@
     p = XML_ParserCreateNS(NULL, '|');
     if(p == NULL)
         return NULL;
+    bd.p = p;
 
     XML_SetReturnNSTriplet(p, 1);
+    /* Prevent the "billion laughs" attack against expat by disabling
+     * internal entity expansion.  With 2.x, forcibly stop the parser
+     * if an entity is declared - this is safer and a more obvious
+     * failure mode.  With older versions, simply prevent expenansion
+     * of such entities. */
+#ifdef HAVE_XML_STOPPARSER
+    XML_SetEntityDeclHandler(p, (void *) _nad_parse_entity_declaration);
+#else
+    XML_SetDefaultHandler(p, NULL);
+#endif
 
     bd.nad = nad_new(cache);
     bd.depth = 0;
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' jabberd2-2.0s11~/util/util.h jabberd2-2.0s11/util/util.h
--- jabberd2-2.0s11~/util/util.h	2005-10-02 10:42:44.000000000 -0500
+++ jabberd2-2.0s11/util/util.h	2011-05-03 20:04:43.000000000 -0500
@@ -764,6 +764,11 @@
 }
 #endif
 
+#if XML_MAJOR_VERSION > 1
+/* XML_StopParser is present in expat 2.x */
+#define HAVE_XML_STOPPARSER
+#endif
+
 #endif    /* INCL_UTIL_H */
 
 
